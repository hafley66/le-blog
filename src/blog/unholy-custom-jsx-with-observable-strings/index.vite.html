<html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1"><meta charSet="UTF-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="stylesheet" href="/styles/colors.css"><link rel="stylesheet" href="/styles/fonts.css"><link rel="stylesheet" href="/styles/global.css"><link rel="stylesheet" href="/styles/nav_and_toc.css"><link rel="stylesheet" href="/styles/hex.css"><link rel="stylesheet" href="/styles/code.css"><link rel="stylesheet" href="/styles/img.css"><link rel="stylesheet" href="/shiki-twoslash.css"><title>True lazy rendering with JSX and RxJS Observables</title></head><body class=""><header><nav id="primary-nav" aria-label="Primary navigation"><div class="nav-links" role="tablist"><a href="/home" role="tab" class="nav-link-anchor"><span class="nav-link ">Home</span></a><a href="/resume" role="tab" class="nav-link-anchor"><span class="nav-link ">Resume</span></a><a href="/blog" role="tab" aria-selected="true" class="nav-link-anchor"><span class="nav-link active">Blog</span></a><a href="/tags" role="tab" class="nav-link-anchor"><span class="nav-link ">Tags</span></a></div></nav></header><main class="body-markdown"><section id="title-and-description"><h1>True lazy rendering with JSX and RxJS Observables</h1><sub>2025-02-25 by Chris Hafley</sub><div id="h1-desc"><em><blockquote>"Do you think God stays in heaven because he too lives in fear of what he's created?"</blockquote></em></div><div class="f-col f-a-center" id="tags" style="margin-bottom:24px;"><div class="responsive-hex-grid-3"><a class="hex-content caption" href="/tags/typescript" style="--hex-color:var(--color-inferno-2);">
      <div class="hex-content hex-shadow">
        <div class="hex-content-amoeba"></div>
      </div>
      <div class="hex-content-amoeba"></div>
      <span>typescript</span>
</a><a class="hex-content caption" href="/tags/javascript" style="--hex-color:var(--color-inferno-4);">
      <div class="hex-content hex-shadow">
        <div class="hex-content-amoeba"></div>
      </div>
      <div class="hex-content-amoeba"></div>
      <span>javascript</span>
</a><a class="hex-content caption" href="/tags/jsx" style="--hex-color:var(--color-inferno-6);">
      <div class="hex-content hex-shadow">
        <div class="hex-content-amoeba"></div>
      </div>
      <div class="hex-content-amoeba"></div>
      <span>jsx</span>
</a><a class="hex-content caption" href="/tags/react" style="--hex-color:var(--color-inferno-8);">
      <div class="hex-content hex-shadow">
        <div class="hex-content-amoeba"></div>
      </div>
      <div class="hex-content-amoeba"></div>
      <span>react</span>
</a><a class="hex-content caption" href="/tags/deno" style="--hex-color:var(--color-inferno-10);">
      <div class="hex-content hex-shadow">
        <div class="hex-content-amoeba"></div>
      </div>
      <div class="hex-content-amoeba"></div>
      <span>deno</span>
</a><a class="hex-content caption" href="/tags/rxjs" style="--hex-color:var(--color-inferno-12);">
      <div class="hex-content hex-shadow">
        <div class="hex-content-amoeba"></div>
      </div>
      <div class="hex-content-amoeba"></div>
      <span>rxjs</span>
</a></div></div></section><details open="true" id="section-table-of-contents"><summary id="toc-header-contents"><h2 id="table-of-contents">Table of Contents</h2><input type="checkbox" id="toc-toggle"></summary><div class="fancy-hr"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 20"><circle cx="10" cy="10" r="7" style="fill:var(--color-text);" stroke-width="2"></circle><circle cx="30" cy="10" r="9" style="fill:var(--color-text);" stroke-width="2" fill="transparent"></circle><circle cx="50" cy="10" r="7" style="fill:var(--color-text);" stroke-width="2"></circle></svg></div><nav id="toc-nav"><div class="debug-slider"></div><ol debug="true"><li debug="true"><a href="#section-abstract">1.  Abstract</a></li></ol></nav></details><div id="main-content-middle"><section id="section-abstract"><h2 id="abstract"><a href="#abstract">1.  Abstract</a></h2><p>I created a jsx implementation that returns <code>Observable&#x3C;string></code> for static site generation(SSG). It uses a really simple technique to determine when a component is ready (first emit!). This round is for unsanitized html over time for my blog.</p><p>You can do both of these with this technique:
Subscribe to every next value of your html over time using...just rxjs.</p><p>Here are 3 main demos demonstrating basic jsx, sync jsx, and async jsx.</p><div class="code-group code-group-1"><div class="code-group-tabs"><input type="radio" name="code-group-1" id="code-group-radio-2" checked="true"><label for="code-group-radio-2"><div class="centerino">Basic Subscribe
</div></label><input type="radio" name="code-group-1" id="code-group-radio-3"><label for="code-group-radio-3"><div class="centerino">Sync children
</div></label><input type="radio" name="code-group-1" id="code-group-radio-4"><label for="code-group-radio-4"><div class="centerino">Async children
</div></label></div><pre class="shiki vitesse-dark" style="background-color:#121212;color:#dbd7caee" tabindex="0"><div class="code-scroller"><code><span class="line"><span style="color:#666666">(&#x3C;</span><span style="color:#4D9375">div</span><span style="color:#666666">></span><span style="color:#DBD7CAEE">Hello World</span><span style="color:#666666">&#x3C;/</span><span style="color:#4D9375">div</span><span style="color:#666666">>).</span><span style="color:#80A665">subscribe</span><span style="color:#666666">(</span><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#BD976A">log</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#758575DD">// Outputs: "&#x3C;div>Hello World&#x3C;/div>"</span></span></code></div><button class="copy-to-clipboard caption">Copy</button></pre><pre class="shiki vitesse-dark" style="background-color:#121212;color:#dbd7caee" tabindex="0"><div class="code-scroller"><code><span class="line"><span style="color:#CB7676">const</span><span style="color:#BD976A"> children</span><span style="color:#666666"> =</span><span style="color:#80A665"> of</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Hello World</span><span style="color:#C98A7D77">"</span><span style="color:#666666">,</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">It was me, DIO</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">(&#x3C;</span><span style="color:#4D9375">div</span><span style="color:#666666">>{</span><span style="color:#BD976A">children</span><span style="color:#666666">}&#x3C;/</span><span style="color:#4D9375">div</span><span style="color:#666666">>).</span><span style="color:#80A665">pipe</span><span style="color:#666666">(</span><span style="color:#80A665">toArray</span><span style="color:#666666">()).</span><span style="color:#80A665">subscribe</span><span style="color:#666666">(</span><span style="color:#BD976A">console</span><span style="color:#666666">.</span><span style="color:#BD976A">log</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#758575DD">// Outputs: ["&#x3C;div>Hello World&#x3C;/div>", "&#x3C;div>It was me, DIO&#x3C;/div>"]</span></span></code></div><button class="copy-to-clipboard caption">Copy</button></pre><pre class="shiki vitesse-dark" style="background-color:#121212;color:#dbd7caee" tabindex="0"><div class="code-scroller"><code><span class="line"><span style="color:#CB7676">const</span><span style="color:#80A665"> fakeUserApiCall</span><span style="color:#666666"> =</span><span style="color:#666666"> ()</span><span style="color:#666666"> =></span><span style="color:#CB7676"> new</span><span style="color:#B8A965"> Promise</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#BD976A">  res</span><span style="color:#666666"> =></span><span style="color:#80A665"> setTimeout</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#666666">    ()</span><span style="color:#666666"> =></span><span style="color:#80A665"> res</span><span style="color:#666666">({</span><span style="color:#B8A965">id</span><span style="color:#666666">:</span><span style="color:#4C9A91"> 0</span><span style="color:#666666">,</span><span style="color:#B8A965"> name</span><span style="color:#666666">:</span><span style="color:#C98A7D77"> "</span><span style="color:#C98A7D">DIO</span><span style="color:#C98A7D77">"</span><span style="color:#666666">}),</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#4C9A91">    100</span></span>
<span class="line"><span style="color:#666666">  )</span></span>
<span class="line"><span style="color:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#666666">  &#x3C;</span><span style="color:#4D9375">div</span><span style="color:#666666">></span></span>
<span class="line"><span style="color:#DBD7CAEE">    Hello World</span></span>
<span class="line"><span style="color:#666666">    &#x3C;</span><span style="color:#4D9375">div</span><span style="color:#666666">>{</span></span>
<span class="line"><span style="color:#CB7676">      new</span><span style="color:#80A665"> Observable</span><span style="color:#666666">(</span><span style="color:#BD976A">sub</span><span style="color:#666666"> =></span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#BD976A">        sub</span><span style="color:#666666">.</span><span style="color:#80A665">next</span><span style="color:#666666">(</span><span style="color:#C98A7D77">"</span><span style="color:#C98A7D">Loading user...</span><span style="color:#C98A7D77">"</span><span style="color:#666666">);</span></span>
<span class="line"><span style="color:#80A665">        fakeUserApiCall</span><span style="color:#666666">().</span><span style="color:#80A665">then</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#BD976A">          i</span><span style="color:#666666"> =></span><span style="color:#BD976A"> sub</span><span style="color:#666666">.</span><span style="color:#80A665">next</span><span style="color:#666666">(</span><span style="color:#BD976A">i</span><span style="color:#666666">)</span><span style="color:#CB7676"> +</span><span style="color:#BD976A"> sub</span><span style="color:#666666">.</span><span style="color:#80A665">complete</span><span style="color:#666666">(),</span><span style="color:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#BD976A">          err</span><span style="color:#666666"> =></span><span style="color:#BD976A"> sub</span><span style="color:#666666">.</span><span style="color:#80A665">error</span><span style="color:#666666">(</span><span style="color:#BD976A">err</span><span style="color:#666666">)</span></span>
<span class="line"><span style="color:#666666">        );</span></span>
<span class="line"><span style="color:#4D9375">        return</span><span style="color:#666666"> ()</span><span style="color:#666666"> =></span><span style="color:#666666"> {</span></span>
<span class="line"><span style="color:#666666">        }</span></span>
<span class="line"><span style="color:#666666">      })</span></span>
<span class="line"><span style="color:#666666">    }&#x3C;/</span><span style="color:#4D9375">div</span><span style="color:#666666">></span></span>
<span class="line"><span style="color:#666666">  &#x3C;/</span><span style="color:#4D9375">div</span><span style="color:#666666">></span></span>
<span class="line"><span style="color:#666666">).</span><span style="color:#80A665">subscribe</span><span style="color:#666666">(</span></span>
<span class="line"><span style="color:#BD976A">  console</span><span style="color:#666666">.</span><span style="color:#BD976A">log</span></span>
<span class="line"><span style="color:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#758575DD">// Outputs: </span></span>
<span class="line"><span style="color:#758575DD">// 1. &#x3C;div> Hello World &#x3C;div> Loading user... &#x3C;/div> &#x3C;/div></span></span>
<span class="line"><span style="color:#758575DD">// 2. &#x3C;div> Hello World &#x3C;div> DIO &#x3C;/div> &#x3C;/div></span></span></code></div><button class="copy-to-clipboard caption">Copy</button></pre><style>
.code-group pre {display:none}
.code-group-1 {

  #code-group-radio-2+label {

  }

  #code-group-radio-2:checked+label {
    background:rgb(18, 18, 18);
    position: relative;
    z-index:1;

    &:hover {
      text-decoration: underline;
      color: white;
    }

    border-top-color: var(--color-red-600);

    &::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 10;
      width: 100%; 
      background: var(--color-red-600);
    }

    &::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 10;
      width: 100%; 
      background: rgba(18, 18, 18, 1.0);;
    }
  }

  &:has(#code-group-radio-2:checked) pre:nth-child(2){ 
    display: block;
  }
  

  #code-group-radio-3+label {

  }

  #code-group-radio-3:checked+label {
    background:rgb(18, 18, 18);
    position: relative;
    z-index:1;

    &:hover {
      text-decoration: underline;
      color: white;
    }

    border-top-color: var(--color-red-600);

    &::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 10;
      width: 100%; 
      background: var(--color-red-600);
    }

    &::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 10;
      width: 100%; 
      background: rgba(18, 18, 18, 1.0);;
    }
  }

  &:has(#code-group-radio-3:checked) pre:nth-child(3){ 
    display: block;
  }
  

  #code-group-radio-4+label {

  }

  #code-group-radio-4:checked+label {
    background:rgb(18, 18, 18);
    position: relative;
    z-index:1;

    &:hover {
      text-decoration: underline;
      color: white;
    }

    border-top-color: var(--color-red-600);

    &::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 10;
      width: 100%; 
      background: var(--color-red-600);
    }

    &::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 10;
      width: 100%; 
      background: rgba(18, 18, 18, 1.0);;
    }
  }

  &:has(#code-group-radio-4:checked) pre:nth-child(4){ 
    display: block;
  }
  
} </style></div><style>
#section-abstract {
  --section-header-hr-start: 0%;
  --section-header-hr-stop: 100%;
}
</style></section></div></main><footer></footer><script>// Smooth scrolling for browsers that don't support CSS smooth scrolling
;(() => {
  /**
   * @type {Record<string, {elem: HTMLElement, percent: number, lastEntry: null | IntersectionObserverEntry}>}
   */
  const byId = {}
  window.sectionById = byId
  /**
   * @type {(typeof byId)[string]}
   */
  let top = null
  /**
   * @type {(typeof byId)[string]}
   */
  let bottom = null

  window.addEventListener("DOMContentLoaded", () => {
    /**
     * @type {HTMLElement}
     */
    const nav = document.getElementById("toc-nav")
    const li = nav?.querySelector("li a")

    let liRatio = li.offsetHeight / nav.offsetHeight

    window.addEventListener("resize", () => {
      console.log("Resize detected")
      liRatio = li.offsetHeight / nav.offsetHeight
    })

    const setEnds = (start, end) => {
      start != null &&
        nav.style.setProperty(
          "--toc-scroll-start",
          "" + (start * 100).toFixed(0) + "%",
        )
      end != null &&
        nav.style.setProperty(
          "--toc-scroll-end",
          "" + (end * 100).toFixed(0) + "%",
        )
    }

    // use elem, its the li
    // now we have its offset from its parent
    // get percent from parent 0 edge
    // that is constant range start

    const observer = new IntersectionObserver(
      entries => {
        entries.forEach(entry => {
          const id = entry.target.getAttribute("id") ?? ""
          let cache =
            // biome-ignore lint/suspicious/noAssignInExpressions: <explanation>
            (byId[id] ||= {
              elem: document.querySelector(
                `nav li a[href="#${id}"]`,
              ),
              percent: 0,
              lastEntry: entry,
            })
          const elem = cache.elem
          cache.lastEntry = entry
          cache.percent = entry.intersectionRatio
          if (entry.isIntersecting) {
            if (entry.intersectionRatio === 1) {
              // console.log("we are golden", cache)
              // console.log("--", elem)
              if (!top) {
                // console.log("A)", elem)
                top = cache
              } else if (
                top.lastEntry.intersectionRect.top >
                  entry.intersectionRect.top ||
                top.lastEntry.time < entry.time
              ) {
                // console.log("AA)", elem)
                // this entry is above the previous top
                top = cache
              } else {
                // console.log(
                //   top.lastEntry,
                //   "does not beat",
                //   entry,
                // )
              }
              // we take full percent of offset + offset+height of LI
            } else if (
              entry.intersectionRect.y ===
                entry.rootBounds.y &&
              entry.intersectionRect.bottom ===
                entry.rootBounds.bottom
            ) {
              // console.log("B)", elem)
              top = cache
              bottom = cache
              // console.log(
              //   "this is both entering/exiting element",
              //   cache,
              // )
            } else if (entry.intersectionRect.y === 0) {
              // console.log(
              //   "this is the leaving element",
              //   cache,
              // )
              // console.log("C)", elem)
              top = cache
            } else {
              // console.log(
              //   "this is the entering element",
              //   cache,
              // )
              // console.log("D)", elem)
              bottom = cache
            }
            if (cache.percent === 0)
              elem?.parentElement?.classList.add(
                "viewtimeline-active",
              )
          } else {
            elem?.parentElement?.classList.remove(
              "viewtimeline-active",
            )
            cache.percent = 0
          }
          console.log(entry.boundingClientRect.top)
          if (entry.boundingClientRect.top < 0) {
            // we have passed the element and are exiting, which means we are stickied. we need to set the var for our mini gradient as a ratio of relative percent of top / height
            const underWater =
              Math.abs(entry.boundingClientRect.top) /
              entry.boundingClientRect.height

            entry.target.style.setProperty(
              "--section-header-hr-progress",
              underWater,
            )
          }
        })
        if (top && bottom) {
          const a = top.elem // get corresponding LI's anchor
          const percentFromNavTop =
            a.offsetTop / a.offsetParent.offsetHeight // this is our base percent we are setting
          // now calculate the intersection ratio relative to

          const percentDiff =
            (a.offsetHeight *
              (1 - top.lastEntry.intersectionRatio)) /
            a.offsetParent.offsetHeight

          const b = bottom.elem
          const percentFromNavTopToBottom =
            (b.offsetTop + b.offsetHeight) /
            b.offsetParent.offsetHeight // this is our base percent we are setting
          // now calculate the intersection ratio relative to

          const percentDiffB =
            (b.offsetHeight *
              (1 - bottom.lastEntry.intersectionRatio)) /
            b.offsetParent.offsetHeight

          // console.log({
          //   top,
          //   bottom,
          //   percentFromNavTop,
          //   percentFromNavTopToBottom,
          //   percentDiff,
          //   percentDiffB,
          //   a,
          //   b,
          // })

          setEnds(
            percentFromNavTop + percentDiff,
            percentFromNavTopToBottom - percentDiffB,
          )
        }
        // console.log({ top, bottom })
      },
      {
        threshold: Array.from(
          { length: 10 },
          (_, i) => i / 10,
        ),
      },
    )

    // Track all sections that have an `id` applied
    document
      .querySelectorAll("#main-content-middle section[id]")
      .forEach(section => {
        observer.observe(section)
      })
  })
})()
;
;document.addEventListener("DOMContentLoaded", () => {
  try {
    const it = document.getElementById("toc-toggle")
    if (it) {
      it.checked = JSON.parse(
        localStorage.tocChecked ?? "false",
      )
      it.addEventListener("change", e => {
        localStorage.tocChecked = !!e.target.checked
      })
    }
  } catch (e) {}
  setTimeout(() => {
    document.body.classList.toggle("ready")
  }, 1)
})
;
;function copyToClipboard(text) {
  navigator.clipboard
    .writeText(text)
    .then(() => {
      // Text copied successfully
      console.log("Text copied to clipboard")
    })
    .catch(err => {
      // Error copying text
      console.error("Failed to copy text: ", err)
    })
}

/**
 * @param {HTMLElement} el
 * @param {Window} win
 */
function selectElementText(el, win) {
  win = win || window
  let doc = win.document
  /**
   * @type {Selection}
   */
  let sel
  /**
   * @type {Range}
   */
  let range

  if (win.getSelection && doc.createRange) {
    sel = win.getSelection()
    range = doc.createRange()
    range.selectNodeContents(el)
    sel.removeAllRanges()
    sel.addRange(range)
  } else if (doc.body.createTextRange) {
    range = doc.body.createTextRange()
    range.moveToElementText(el)
    range.select()
  }
  console.log(sel.toString())
  return sel.toString()
}

document.addEventListener("click", e => {
  let target =
    e.target.classList.contains("copy-to-clipboard") &&
    e.target.parentElement.classList.contains("shiki")
      ? e.target
      : null
  target = target?.parentElement.querySelector("code")
  if (target) {
    copyToClipboard(selectElementText(target))
    window.getSelection().removeAllRanges()
  }
})
;
;let isZoomin = false
let container = null
const remove = () => {
  if (!container) return
  container?.remove()
  container = null
  const it = document.querySelector(".img-zoom")
  it?.classList.toggle("img-zoom")
  isZoomin = false
}
document.addEventListener("click", e => {
  if (
    isZoomin &&
    e.target.classList.contains("img-zoom-clone-parent")
  ) {
    document
      .querySelector(".img-zoom-clone-exit")
      ?.dispatchEvent(
        new MouseEvent("click", {
          view: window,
          bubbles: true,
          cancelable: false,
        }),
      )
  }

  if (e.target.tagName === "IMG") {
    if (e.target.classList.contains("img-zoom-clone")) {
      return
    }
    if (!e.target.classList.contains("img-zoom")) {
      /**
       * @type {HTMLImageElement}
       */
      const orig = e.target
      /**
       * @type {HTMLImageElement}
       */
      const clone = e.target.cloneNode()
      clone.classList.add("img-zoom-clone")

      container = document.createElement("div")
      container.classList.add("img-zoom-clone-parent")

      const behind = document.createElement("div")
      behind.classList.add("behind")

      const exitButton = document.createElement("button")
      exitButton.classList.add("img-zoom-clone-exit")
      ;[exitButton, behind].forEach(i =>
        i.addEventListener("click", remove),
      )
      isZoomin = true

      exitButton.setAttribute("aria-role", "button")
      exitButton.setAttribute("type", "button")
      exitButton.innerHTML = "Close"

      container.appendChild(behind)
      container.appendChild(clone)
      container.appendChild(exitButton)

      document.body.appendChild(container)
      e.target.classList.toggle("img-zoom")
      requestAnimationFrame(() => {
        exitButton.focus()
      })
    }
  }
})

document.addEventListener("keyup", e => {
  if (e.key === "Escape" && isZoomin) {
    remove()
  }
})
</script></body></html>